# Reusable Workflow: Deploy to Expo Snack
#
# This workflow should be placed in the lumea-apps/workflows repository
# at .github/workflows/deploy-snack.yml
#
# It handles:
# 1. Creating/updating an Expo Snack from the repository
# 2. Calling the Lumea webhook with the Snack URL
#
# Secrets are inherited from the lumea-apps organization:
# - LUMEA_WEBHOOK_SECRET: Shared secret for webhook authentication
#
# @see SHO-122 - Mobile Preview via Snack

name: Deploy to Snack

on:
  workflow_call:
    inputs:
      lumea_project_id:
        description: 'Lumea Project ID'
        required: true
        type: string
    secrets:
      LUMEA_WEBHOOK_SECRET:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create Snack
        id: snack
        run: |
          set -e

          # Read app name from package.json (with fallback)
          if [ -f "package.json" ]; then
            APP_NAME=$(node -e "console.log(require('./package.json').name || 'expo-app')")
          else
            APP_NAME="expo-app"
          fi

          echo "Creating Snack for: $APP_NAME"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"

          # Create a Node.js script to build the Snack payload
          cat > /tmp/create-snack.js << 'SCRIPT_EOF'
          const fs = require('fs');
          const path = require('path');

          // Files to include in Snack
          const files = {};

          // Add a file to the payload
          function addFile(filePath) {
            if (fs.existsSync(filePath)) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                files[filePath] = { type: 'CODE', contents: content };
              } catch (e) {
                console.error(`Warning: Could not read ${filePath}:`, e.message);
              }
            }
          }

          // Add key files
          ['App.tsx', 'App.js', 'app.json', 'package.json', 'babel.config.js', 'tsconfig.json'].forEach(addFile);

          // Add files from common directories
          const dirs = ['src', 'components', 'screens', 'hooks', 'utils', 'lib', 'app'];
          let fileCount = 0;
          const maxFiles = 50;

          function scanDir(dir) {
            if (!fs.existsSync(dir) || fileCount >= maxFiles) return;
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              if (fileCount >= maxFiles) break;
              const fullPath = path.join(dir, entry.name);
              if (entry.isDirectory() && !entry.name.startsWith('.') && entry.name !== 'node_modules') {
                scanDir(fullPath);
              } else if (entry.isFile() && /\.(ts|tsx|js|jsx|json)$/.test(entry.name)) {
                addFile(fullPath);
                fileCount++;
              }
            }
          }

          dirs.forEach(scanDir);

          // Read dependencies
          let dependencies = {};
          if (fs.existsSync('package.json')) {
            try {
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              dependencies = pkg.dependencies || {};
            } catch (e) {}
          }

          // Build Snack payload
          const payload = {
            name: process.argv[2] || 'expo-app',
            description: `Deployed from ${process.argv[3] || 'Lumea'}`,
            files: files,
            dependencies: dependencies,
            sdkVersion: '52.0.0'
          };

          console.log(JSON.stringify(payload));
          SCRIPT_EOF

          # Generate Snack payload
          SNACK_PAYLOAD=$(node /tmp/create-snack.js "$APP_NAME" "${{ github.repository }}")

          # Save to Snack API
          echo "Uploading to Snack API..."
          RESPONSE=$(curl -s -X POST "https://snack.expo.dev/api/v2/snack/save" \
            -H "Content-Type: application/json" \
            -d "$SNACK_PAYLOAD")

          # Extract Snack ID from response
          SNACK_ID=$(echo "$RESPONSE" | node -e "const d=require('fs').readFileSync(0,'utf8');try{console.log(JSON.parse(d).id||'')}catch{console.log('')}")

          if [ -z "$SNACK_ID" ]; then
            echo "Failed to create Snack"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Build Snack URLs
          SNACK_WEB_URL="https://snack.expo.dev/$SNACK_ID"
          SNACK_EXPO_URL="exp://exp.host/@snack/$SNACK_ID"

          echo "snack_id=$SNACK_ID" >> $GITHUB_OUTPUT
          echo "snack_url=$SNACK_EXPO_URL" >> $GITHUB_OUTPUT
          echo "snack_web_url=$SNACK_WEB_URL" >> $GITHUB_OUTPUT

          echo "Snack created successfully!"
          echo "Web URL: $SNACK_WEB_URL"
          echo "Expo URL: $SNACK_EXPO_URL"

      - name: Notify Lumea (Success)
        if: success()
        run: |
          curl -X POST "${{ vars.LUMEA_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.LUMEA_WEBHOOK_SECRET }}" \
            -d '{
              "projectId": "${{ inputs.lumea_project_id }}",
              "type": "mobile",
              "status": "ready",
              "snackUrl": "${{ steps.snack.outputs.snack_url }}",
              "snackId": "${{ steps.snack.outputs.snack_id }}",
              "commitSha": "${{ github.sha }}"
            }'

      - name: Notify Lumea (Failure)
        if: failure()
        run: |
          curl -X POST "${{ vars.LUMEA_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.LUMEA_WEBHOOK_SECRET }}" \
            -d '{
              "projectId": "${{ inputs.lumea_project_id }}",
              "type": "mobile",
              "status": "error",
              "error": "Failed to create Snack",
              "commitSha": "${{ github.sha }}"
            }'
