# Reusable Workflow: Deploy to Vercel
#
# This workflow should be placed in the lumea-apps/workflows repository
# at .github/workflows/deploy-vercel.yml
#
# It handles:
# 1. Syncing project secrets to Vercel environment variables
# 2. Building the project with Vercel CLI
# 3. Deploying to Vercel
# 4. Configuring platform and custom domains
# 5. Calling the Lumea webhook with results
#
# Secrets are inherited from the lumea-apps organization:
# - VERCEL_TOKEN: Vercel API token
# - VERCEL_ORG_ID: Vercel team/org ID
# - WEBHOOK_SECRET: Shared secret for webhook authentication
# - PROJECT_SECRETS: JSON with project environment variables (optional)
#
# @see SHO-96 - Project Secrets Management

name: Deploy to Vercel

on:
  workflow_call:
    inputs:
      project_slug:
        description: 'Project slug for platform domain'
        required: true
        type: string
      lumea_project_id:
        description: 'Lumea Project ID'
        required: true
        type: string
      custom_domain:
        description: 'Custom domain to configure (optional)'
        required: false
        type: string
        default: ''
      app_target:
        description: 'App target for secrets filtering (web, api, worker, all)'
        required: false
        type: string
        default: 'all'
    # Secrets are inherited from org level via `secrets: inherit`
    secrets:
      VERCEL_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      LUMEA_WEBHOOK_SECRET:
        required: true
      PROJECT_SECRETS:
        required: false

env:
  PLATFORM_DOMAIN: lumea-ai.app

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Vercel CLI
        run: bun add -g vercel@latest

      - name: Link Vercel Project
        run: vercel link --yes --token=${{ secrets.VERCEL_TOKEN }}

      - name: Disable Deployment Protection
        run: |
          # Get project ID from .vercel/project.json
          PROJECT_ID=$(cat .vercel/project.json | jq -r '.projectId')

          echo "Disabling deployment protection for project: $PROJECT_ID"

          # Disable SSO Protection (Vercel Authentication) and Password Protection
          # This allows public access to preview deployments
          # @see https://vercel.com/docs/rest-api/reference/endpoints/projects/update-an-existing-project
          RESPONSE=$(curl -s -X PATCH "https://api.vercel.com/v9/projects/$PROJECT_ID?teamId=${{ secrets.VERCEL_ORG_ID }}" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "ssoProtection": null,
              "passwordProtection": null
            }')

          # Check if request was successful
          if echo "$RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
            echo "✓ Deployment protection disabled successfully"
          else
            echo "⚠ Warning: Could not disable deployment protection"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Sync environment variables to Vercel
        run: |
          SECRETS='${{ secrets.PROJECT_SECRETS }}'
          TARGET="${{ inputs.app_target }}"

          if [ -z "$SECRETS" ] || [ "$SECRETS" = "" ]; then
            echo "No project secrets configured, skipping sync"
            exit 0
          fi

          echo "Syncing environment variables for target: $TARGET"

          # Combine "all" target with specific target
          # Format: { "all": {...}, "web": {...}, "api": {...} }
          echo "$SECRETS" | jq -r "
            ((.all // {}) + (.[\"$TARGET\"] // {}))
            | to_entries[]
            | @base64
          " | while read -r entry; do
            KEY=$(echo "$entry" | base64 -d | jq -r '.key')
            VALUE=$(echo "$entry" | base64 -d | jq -r '.value')

            # Remove existing env var if it exists (ignore errors)
            vercel env rm "$KEY" production -y --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true

            # Add new value
            echo "$VALUE" | vercel env add "$KEY" production --token=${{ secrets.VERCEL_TOKEN }}

            echo "✓ Synced: $KEY"
          done

          echo "Environment variables sync complete"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Build with Vercel
        id: build
        run: |
          # Build the project (creates .vercel/output)
          vercel build --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          # Deploy prebuilt output
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --yes --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

          # Extract project info from .vercel/project.json if it exists
          if [ -f .vercel/project.json ]; then
            PROJECT_ID=$(cat .vercel/project.json | jq -r '.projectId')
            PROJECT_NAME=$(cat .vercel/project.json | jq -r '.settings.name // empty')
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
            echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Configure Platform Domain
        id: platform_domain
        run: |
          PLATFORM_DOMAIN="${{ inputs.project_slug }}.${{ env.PLATFORM_DOMAIN }}"
          echo "Configuring platform domain: $PLATFORM_DOMAIN"

          # Alias deployment to platform domain
          vercel alias ${{ steps.deploy.outputs.deployment_url }} $PLATFORM_DOMAIN \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} 2>&1 || echo "Platform domain alias may already exist"

          echo "platform_domain=$PLATFORM_DOMAIN" >> $GITHUB_OUTPUT

      - name: Configure Custom Domain
        id: custom_domain
        if: inputs.custom_domain != ''
        run: |
          CUSTOM_DOMAIN="${{ inputs.custom_domain }}"
          echo "Configuring custom domain: $CUSTOM_DOMAIN"

          # Alias deployment to custom domain
          ALIAS_RESULT=$(vercel alias ${{ steps.deploy.outputs.deployment_url }} $CUSTOM_DOMAIN \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} 2>&1) || true

          echo "$ALIAS_RESULT"

          # Check if domain needs verification
          if echo "$ALIAS_RESULT" | grep -q "verification"; then
            echo "custom_domain_verified=false" >> $GITHUB_OUTPUT
          else
            echo "custom_domain_verified=true" >> $GITHUB_OUTPUT
          fi

          # Get domain verification challenge if needed
          DOMAIN_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v10/projects/${{ steps.deploy.outputs.project_id }}/domains/$CUSTOM_DOMAIN?teamId=${{ secrets.VERCEL_ORG_ID }}")

          # Extract verification info
          VERIFIED=$(echo "$DOMAIN_INFO" | jq -r '.verified // false')
          CHALLENGE_TYPE=$(echo "$DOMAIN_INFO" | jq -r '.verification[0].type // empty')
          CHALLENGE_DOMAIN=$(echo "$DOMAIN_INFO" | jq -r '.verification[0].domain // empty')
          CHALLENGE_VALUE=$(echo "$DOMAIN_INFO" | jq -r '.verification[0].value // empty')
          CHALLENGE_REASON=$(echo "$DOMAIN_INFO" | jq -r '.verification[0].reason // empty')

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "challenge_type=$CHALLENGE_TYPE" >> $GITHUB_OUTPUT
          echo "challenge_domain=$CHALLENGE_DOMAIN" >> $GITHUB_OUTPUT
          echo "challenge_value=$CHALLENGE_VALUE" >> $GITHUB_OUTPUT
          echo "challenge_reason=$CHALLENGE_REASON" >> $GITHUB_OUTPUT

      - name: Notify Lumea (Success)
        if: success()
        run: |
          # Build webhook payload
          PAYLOAD=$(cat <<EOF
          {
            "projectId": "${{ inputs.lumea_project_id }}",
            "status": "ready",
            "deploymentUrl": "${{ steps.deploy.outputs.deployment_url }}",
            "platformDomain": "${{ steps.platform_domain.outputs.platform_domain }}",
            "workflowRunId": "${{ github.run_id }}",
            "commitSha": "${{ github.sha }}",
            "logsUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "deploymentConfig": {
              "provider": "vercel",
              "projectId": "${{ steps.deploy.outputs.project_id }}",
              "projectName": "lumea-${{ inputs.project_slug }}"
            }
          EOF
          )

          # Add custom domain info if configured
          if [ -n "${{ inputs.custom_domain }}" ]; then
            CUSTOM_DOMAIN_PAYLOAD=$(cat <<EOF
            ,
            "customDomain": "${{ inputs.custom_domain }}",
            "customDomainVerified": ${{ steps.custom_domain.outputs.verified || 'false' }}
          EOF
            )

            # Add challenge if present
            if [ -n "${{ steps.custom_domain.outputs.challenge_type }}" ]; then
              CHALLENGE_PAYLOAD=$(cat <<EOF
              ,
              "customDomainChallenge": {
                "type": "${{ steps.custom_domain.outputs.challenge_type }}",
                "domain": "${{ steps.custom_domain.outputs.challenge_domain }}",
                "value": "${{ steps.custom_domain.outputs.challenge_value }}",
                "reason": "${{ steps.custom_domain.outputs.challenge_reason }}"
              }
          EOF
              )
              CUSTOM_DOMAIN_PAYLOAD="${CUSTOM_DOMAIN_PAYLOAD}${CHALLENGE_PAYLOAD}"
            fi

            PAYLOAD="${PAYLOAD}${CUSTOM_DOMAIN_PAYLOAD}"
          fi

          PAYLOAD="${PAYLOAD}}"

          echo "Sending webhook to Lumea..."
          curl -X POST "${{ vars.LUMEA_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.LUMEA_WEBHOOK_SECRET }}" \
            -d "$PAYLOAD"

      - name: Notify Lumea (Failure)
        if: failure()
        run: |
          curl -X POST "${{ vars.LUMEA_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.LUMEA_WEBHOOK_SECRET }}" \
            -d '{
              "projectId": "${{ inputs.lumea_project_id }}",
              "status": "error",
              "error": "Build or deployment failed",
              "workflowRunId": "${{ github.run_id }}",
              "logsUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'
